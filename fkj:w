import React, { useContext, useEffect, useId, useRef, useState } from "react";
import { GameState } from "./types/game";
import TypingText from "./components/TypingText";
import { WebsocketContext } from "./components/SocketContext";
import { SessionContext } from "./components/SessionContext";

const Game: React.FC = () => {
	const [ready, msg, sockSend] = useContext(WebsocketContext);
	const { sessionData } = useContext(SessionContext);
	const [gameState, setGameState] = useState<GameState>({ currentWord: "", currentWordIdx: 0, wordList: [] });
	const gameDiv = useRef<HTMLDivElement>(null);

	useEffect(() => {
		// console.log("received: ", msg)
		console.log('Game state: ', gameState)
	}, [msg])

	useEffect(() => {
		const handleKeyPress = (e: KeyboardEvent) => {
			if (!ready) {
				return
			}
			if (e.key == ' ') {

				e.preventDefault();
			}

			setGameState(prev => {
				const correct = prev.wordList[prev.currentWordIdx] == prev.currentWord;
				if (correct && e.key === ' ') {
					return {
						...prev,
						currentWord: "",
						currentWordIdx: prev.currentWordIdx + 1,
					}
				} else { return prev; }
			})

			if (e.key == "Backspace") {
				setGameState(prev => ({
					...prev,
					currentWord: prev.currentWord.slice(0, prev.currentWord.length - 1),
				}));
			}

			if (e.key.length === 1) {
				const c = e.key.charCodeAt(0);
				if (c > 32 && c < 127) {
					setGameState(prev => ({
						...prev,
						currentWord: prev.currentWord.concat(e.key),
					}));
				}
			}
			const a = JSON.stringify(
				{
					cmd_type: "type",
					args: [e.key],
					user_id: sessionData?.user_id

				}
			)
			sockSend!(a)
		}

		gameDiv.current?.addEventListener('keydown', handleKeyPress)
		gameDiv.current?.focus()

		return () => {
			gameDiv.current?.removeEventListener('keydown', handleKeyPress)
		}
	}, [ready])

	useEffect(() => {
		setGameState({
			wordList: [],
			currentWord: "",
			currentWordIdx: 0,
		})
		const getWords = async () => {
			try {
				const response = await fetch("http://localhost:8000/game", {
					credentials: "include"
				});

				if (!response.ok) {
					console.error("Error retrieving data from the server");
				}

				const data = await response.json();
				setGameState(prev => ({
					...prev,
					wordList: data.word_list
				}))
			} catch (e) {
				console.error(e);
			}
		}

		getWords();

	}, [])


	return <div className="game" ref={gameDiv} tabIndex={0}>
		{/* <TypingText {...gameState} /> */}
		{sessionData?.user_id}
		{ready && <TypingText {...gameState} />}
	</div>

}

export default Game;
